<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LifeLine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">LifeLine</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link">üëë Admin Dashboard</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile.html">‚öôÔ∏è Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">üö™ Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <h2 class="mb-4">Admin Dashboard</h2>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 id="totalUsers">0</h3>
                    <p>üë• Total Users</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 id="totalDonors">0</h3>
                    <p>ü©∏ Total Donors</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 id="activeRequests">0</h3>
                    <p>üìã Active Requests</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 id="completedRequests">0</h3>
                    <p>‚úÖ Completed Requests</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#requests">Blood Requests</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#staff">Staff Approvals</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#campaigns">Campaign Management</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#storage">Blood Storage</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Blood Requests Tab -->
            <div class="tab-pane fade show active" id="requests">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">All Blood Requests</h4>
                    </div>
                    <div class="card-body">
                        <div id="requestsList"></div>
                    </div>
                </div>
            </div>

            <!-- Staff Approvals Tab -->
            <div class="tab-pane fade" id="staff">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Pending Staff Registrations</h4>
                        <button class="btn btn-success" onclick="showRegisterStaffModal()">
                            <i class="bi bi-person-plus"></i> Register New Staff
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="staffList"></div>
                    </div>
                </div>
            </div>

            <!-- Campaign Management Tab -->
            <div class="tab-pane fade" id="campaigns">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">All Campaigns</h4>
                        <button class="btn btn-success" onclick="showCreateCampaignModal()">
                            + Create Campaign
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="campaignsList"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Pending Staff Campaign Requests</h4>
                    </div>
                    <div class="card-body">
                        <div id="campaignRequestsList"></div>
                    </div>
                </div>
            </div>

            <!-- Blood Storage Tab -->
            <div class="tab-pane fade" id="storage">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Blood Inventory</h4>
                        <button class="btn btn-success" onclick="showAddBloodModal()">
                            <i class="bi bi-plus-circle"></i> Add Blood
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="storageList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div class="modal fade" id="createCampaignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCampaignForm">
                        <div class="mb-3">
                            <label for="campaignName" class="form-label">Campaign Name *</label>
                            <input type="text" class="form-control" id="campaignName" required>
                        </div>
                        <div class="mb-3">
                            <label for="campaignDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="campaignDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startDate" class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endDate" class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="campaignZilla" class="form-label">Zilla/District *</label>
                                <select class="form-select" id="campaignZilla" required>
                                    <option value="">Select Zilla</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="campaignThana" class="form-label">Thana/Upazila</label>
                                <select class="form-select" id="campaignThana">
                                    <option value="">Select Thana</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="requiredDoctors" class="form-label">Required Doctors</label>
                                <input type="number" class="form-control" id="requiredDoctors" value="5" min="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="requiredOrganizers" class="form-label">Required Organizers</label>
                                <input type="number" class="form-control" id="requiredOrganizers" value="5" min="1">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCampaign()">Create Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;

            const user = getUser();
            if (!user.is_admin) {
                alert('Access denied. Admin privileges required.');
                window.location.href = '/';
                return;
            }

            await loadDashboard();
            await loadRequests();
            await loadPendingStaff();
        });

        async function loadDashboard() {
            try {
                const data = await apiCall('/admin/dashboard');

                document.getElementById('totalUsers').textContent = data.statistics.total_users;
                document.getElementById('totalDonors').textContent = data.statistics.total_donors;
                document.getElementById('activeRequests').textContent = data.statistics.active_requests;
                document.getElementById('completedRequests').textContent = data.statistics.completed_requests;

                // Store full blood storage data for breakdown view
                window.bloodStorageData = data.blood_storage;

                // Load blood storage summary (nationwide totals) - clickable
                const storageContainer = document.getElementById('storageList');
                storageContainer.innerHTML = `
                    <div class="row g-3">
                        ${data.blood_storage_summary.map(storage => `
                            <div class="col-md-3">
                                <div class="card text-center" style="cursor: pointer;" onclick="showBloodTypeBreakdown('${storage.blood_type}')">
                                    <div class="card-body">
                                        ${getBloodTypeBadge(storage.blood_type)}
                                        <h3 class="mt-3">${storage.total_units}</h3>
                                        <p class="mb-0">Units Available</p>
                                        <small class="text-muted">(Nationwide)</small>
                                        <div class="mt-2">
                                            <small class="text-primary"><i class="bi bi-hand-index"></i> Click for breakdown</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        function showBloodTypeBreakdown(bloodType) {
            // Filter storage data for this blood type
            const breakdown = window.bloodStorageData
                .filter(s => s.blood_type === bloodType)
                .sort((a, b) => b.units_available - a.units_available); // Sort by units descending

            // Populate modal
            document.getElementById('breakdownBloodType').textContent = bloodType;
            document.getElementById('breakdownBloodTypeBadge').innerHTML = getBloodTypeBadge(bloodType);

            const breakdownList = document.getElementById('breakdownList');
            breakdownList.innerHTML = breakdown.map(item => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span>${item.zilla_name}</span>
                    <span class="badge ${item.units_available > 0 ? 'bg-success' : 'bg-secondary'} rounded-pill">
                        ${item.units_available} units
                    </span>
                </div>
            `).join('');

            // Show modal
            new bootstrap.Modal(document.getElementById('bloodBreakdownModal')).show();
        }

        async function loadRequests() {
            showLoading('requestsList');

            try {
                const data = await apiCall('/admin/requests');
                const container = document.getElementById('requestsList');

                if (data.requests.length === 0) {
                    container.innerHTML = '<p class="text-muted">No requests found.</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Receiver</th>
                                    <th>Blood Type</th>
                                    <th>Units</th>
                                    <th>Date Needed</th>
                                    <th>Status</th>
                                    <th>Crossmatch</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.requests.map(req => `
                                    <tr>
                                        <td>#${req.id}</td>
                                        <td>
                                            <a href="#" onclick="showUserActions(${req.receiver_id}, '${req.receiver_name}'); return false;" class="text-primary" style="cursor: pointer; text-decoration: underline;">
                                                ${req.receiver_name}
                                            </a>
                                        </td>
                                        <td>${getBloodTypeBadge(req.blood_type)}</td>
                                        <td>${req.units}</td>
                                        <td>${formatDate(req.date_needed)}</td>
                                        <td>${getStatusBadge(req.status)}</td>
                                        <td>
                                            ${req.crossmatch_status === 'passed' ? '<span class="badge bg-success">PASSED</span>' :
                        req.crossmatch_status === 'failed' ? '<span class="badge bg-danger">FAILED</span>' :
                            '<span class="badge bg-secondary">PENDING</span>'}
                                        </td>
                                        <td>
                                            ${req.status === 'crossmatch_passed' ? `
                                                <button class="btn btn-sm btn-success" onclick="completeRequest(${req.id})">
                                                    ‚úì Complete
                                                </button>
                                            ` : ''}
                                            ${req.status !== 'completed' && req.status !== 'cancelled' ? `
                                                <button class="btn btn-sm btn-danger" onclick="cancelRequest(${req.id})">
                                                    ‚úó Cancel
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                document.getElementById('requestsList').innerHTML = '<p class="text-danger">Failed to load requests.</p>';
            }
        }

        async function completeRequest(requestId) {
            if (!confirm('Mark this request as completed? This will award points to the donor.')) return;

            try {
                await apiCall(`/admin/requests/${requestId}/complete`, 'POST');
                showAlert('Request completed successfully! Donor points awarded.', 'success');
                await loadDashboard();
                await loadRequests();
            } catch (error) {
                showAlert('Failed to complete request: ' + error.message, 'danger');
            }
        }

        async function cancelRequest(requestId) {
            if (!confirm('Cancel this request?')) return;

            const reason = prompt('Reason for cancellation:');
            if (!reason) return;

            try {
                await apiCall(`/admin/requests/${requestId}/cancel`, 'POST', { reason });
                showAlert('Request cancelled successfully', 'success');
                await loadDashboard();
                await loadRequests();
            } catch (error) {
                showAlert('Failed to cancel request: ' + error.message, 'danger');
            }
        }

        async function loadPendingStaff() {
            showLoading('staffList');

            try {
                const data = await apiCall('/admin/staff/pending');
                const container = document.getElementById('staffList');

                if (data.pending_staff.length === 0) {
                    container.innerHTML = '<p class="text-muted">No pending staff registrations.</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Role</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.pending_staff.map(staff => `
                                    <tr>
                                        <td>${staff.full_name}</td>
                                        <td>${staff.email}</td>
                                        <td>${staff.phone}</td>
                                        <td><span class="badge bg-info">${staff.staff_role?.toUpperCase()}</span></td>
                                        <td>${staff.thana_name}, ${staff.zilla_name}</td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="approveStaff(${staff.id})">
                                                ‚úì Approve
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectStaff(${staff.id})">
                                                ‚úó Reject
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                document.getElementById('staffList').innerHTML = '<p class="text-danger">Failed to load pending staff.</p>';
            }
        }

        async function approveStaff(staffId) {
            try {
                await apiCall('/admin/staff/approve', 'POST', { staff_id: staffId });
                showAlert('Staff approved successfully', 'success');
                await loadPendingStaff();
            } catch (error) {
                showAlert('Failed to approve staff: ' + error.message, 'danger');
            }
        }

        async function rejectStaff(staffId) {
            const reason = prompt('Reason for rejection:');
            if (!reason) return;

            try {
                await apiCall('/admin/staff/reject', 'POST', { staff_id: staffId, reason });
                showAlert('Staff rejected', 'success');
                await loadPendingStaff();
            } catch (error) {
                showAlert('Failed to reject staff: ' + error.message, 'danger');
            }
        }

        // Campaign Management Functions
        async function loadCampaigns() {
            showLoading('campaignsList');

            try {
                const data = await apiCall('/admin/campaigns');
                const container = document.getElementById('campaignsList');

                if (data.campaigns.length === 0) {
                    container.innerHTML = '<p class="text-muted">No campaigns found.</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Assigned Staff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.campaigns.map(campaign => `
                                    <tr>
                                        <td>#${campaign.id}</td>
                                        <td>${campaign.campaign_name}</td>
                                        <td>${campaign.thana_name || 'N/A'}, ${campaign.zilla_name}</td>
                                        <td>${formatDate(campaign.start_date)}</td>
                                        <td>${formatDate(campaign.end_date)}</td>
                                        <td><span class="badge bg-info">${campaign.status?.toUpperCase()}</span></td>
                                        <td><span class="badge bg-success">${campaign.staff_count || 0} staff</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="showAssignStaffModal(${campaign.id}, '${campaign.campaign_name}')">
                                                Assign Staff
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                document.getElementById('campaignsList').innerHTML = '<p class="text-danger">Failed to load campaigns.</p>';
            }
        }

        async function loadCampaignRequests() {
            showLoading('campaignRequestsList');

            try {
                const data = await apiCall('/admin/campaign-requests');
                const container = document.getElementById('campaignRequestsList');

                if (data.requests.length === 0) {
                    container.innerHTML = '<p class="text-muted">No pending campaign requests.</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Staff Name</th>
                                    <th>Role</th>
                                    <th>Campaign</th>
                                    <th>Location</th>
                                    <th>Requested On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.requests.map(req => `
                                    <tr>
                                        <td>${req.staff_name}</td>
                                        <td><span class="badge bg-info">${req.staff_role?.toUpperCase()}</span></td>
                                        <td>${req.campaign_name}</td>
                                        <td>${req.thana_name}, ${req.zilla_name}</td>
                                        <td>${formatDateTime(req.requested_at)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="approveCampaignRequest(${req.staff_id}, ${req.campaign_id})">
                                                ‚úì Approve
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectCampaignRequest(${req.staff_id}, ${req.campaign_id})">
                                                ‚úó Reject
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                document.getElementById('campaignRequestsList').innerHTML = '<p class="text-danger">Failed to load campaign requests.</p>';
            }
        }

        async function approveCampaignRequest(staffId, campaignId) {
            try {
                await apiCall('/admin/campaign-requests/approve', 'POST', { staff_id: staffId, campaign_id: campaignId });
                showAlert('Campaign request approved successfully', 'success');
                await loadCampaignRequests();
                await loadCampaigns();
            } catch (error) {
                showAlert('Failed to approve request: ' + error.message, 'danger');
            }
        }

        async function rejectCampaignRequest(staffId, campaignId) {
            if (!confirm('Reject this campaign request?')) return;

            try {
                await apiCall('/admin/campaign-requests/reject', 'POST', { staff_id: staffId, campaign_id: campaignId });
                showAlert('Campaign request rejected', 'success');
                await loadCampaignRequests();
            } catch (error) {
                showAlert('Failed to reject request: ' + error.message, 'danger');
            }
        }

        function showAssignStaffModal(campaignId, campaignName) {
            // For now, show a simple prompt. You can enhance this with a proper modal later
            const staffId = prompt(`Enter Staff ID to assign to campaign "${campaignName}":`);
            if (!staffId) return;

            assignStaffToCampaign(parseInt(staffId), campaignId);
        }

        async function assignStaffToCampaign(staffId, campaignId) {
            try {
                await apiCall('/admin/campaigns/assign-staff', 'POST', { staff_id: staffId, campaign_id: campaignId });
                showAlert('Staff assigned to campaign successfully', 'success');
                await loadCampaigns();
            } catch (error) {
                showAlert('Failed to assign staff: ' + error.message, 'danger');
            }
        }

        // Load campaigns when tab is clicked
        document.querySelector('[data-bs-target="#campaigns"]').addEventListener('click', async () => {
            await loadCampaigns();
            await loadCampaignRequests();
        });

        // Show Create Campaign Modal
        async function showCreateCampaignModal() {
            // Load zillas for the modal
            await loadZillas('campaignZilla');

            // Setup thana loading when zilla changes
            document.getElementById('campaignZilla').addEventListener('change', async (e) => {
                const zillaId = e.target.value;
                if (zillaId) {
                    await loadThanas(zillaId, 'campaignThana');
                } else {
                    document.getElementById('campaignThana').innerHTML = '<option value="">Select Thana</option>';
                }
            });

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('createCampaignModal'));
            modal.show();
        }

        // Create Campaign
        async function createCampaign() {
            const form = document.getElementById('createCampaignForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const campaignData = {
                name: document.getElementById('campaignName').value,
                description: document.getElementById('campaignDescription').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                location_zilla: parseInt(document.getElementById('campaignZilla').value),
                location_thana: document.getElementById('campaignThana').value ? parseInt(document.getElementById('campaignThana').value) : null,
                required_doctors: parseInt(document.getElementById('requiredDoctors').value),
                required_organizers: parseInt(document.getElementById('requiredOrganizers').value)
            };

            try {
                await apiCall('/admin/campaigns', 'POST', campaignData);
                showAlert('Campaign created successfully!', 'success');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'));
                modal.hide();

                // Reset form
                form.reset();

                // Reload campaigns
                await loadCampaigns();
            } catch (error) {
                showAlert('Failed to create campaign: ' + error.message, 'danger');
            }
        }
    </script>
</body>

</html>
<!-- Blood Type Breakdown Modal -->
<div class="modal fade" id="bloodBreakdownModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="breakdownBloodTypeBadge"></span>
                    <span id="breakdownBloodType"></span> - District Breakdown
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="breakdownList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Add Blood Modal -->
<div class="modal fade" id="addBloodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Blood to Storage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBloodForm">
                    <div class="mb-3">
                        <label for="addBloodZilla" class="form-label">District (Zilla)</label>
                        <select class="form-select" id="addBloodZilla" required>
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addBloodType" class="form-label">Blood Type</label>
                        <select class="form-select" id="addBloodType" required>
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addBloodUnits" class="form-label">Number of Units</label>
                        <input type="number" class="form-control" id="addBloodUnits" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitAddBlood()">Add Blood</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function showAddBloodModal() {
        // Load zillas for dropdown
        try {
            const data = await apiCall("/locations/zillas");
            const select = document.getElementById("addBloodZilla");
            select.innerHTML = "\u003coption value=\"\"\u003eSelect District\u003c/option\u003e" +
                data.zillas.map(z => `\u003coption value="${z.id}"\u003e${z.name}\u003c/option\u003e`).join("");

            new bootstrap.Modal(document.getElementById("addBloodModal")).show();
        } catch (error) {
            showAlert("Failed to load districts", "danger");
        }
    }

    async function submitAddBlood() {
        const zilla_id = document.getElementById("addBloodZilla").value;
        const blood_type = document.getElementById("addBloodType").value;
        const units = parseInt(document.getElementById("addBloodUnits").value);

        if (!zilla_id || !blood_type || !units) {
            showAlert("Please fill all fields", "warning");
            return;
        }

        try {
            const result = await apiCall("/admin/blood-storage/add", "POST", {
                zilla_id: parseInt(zilla_id),
                blood_type,
                units
            });

            showAlert(result.message, "success");
            bootstrap.Modal.getInstance(document.getElementById("addBloodModal")).hide();
            document.getElementById("addBloodForm").reset();

            // Reload dashboard to show updated inventory
            await loadDashboard();
        } catch (error) {
            showAlert("Failed to add blood: " + error.message, "danger");
        }
    }
</script>
<!-- User Actions Modal -->
<div class="modal fade" id="userActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Actions - <span id="userActionName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="banUser()">
                        <i class="bi bi-ban"></i> Ban User
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedUserId = null;
    let selectedUserName = null;

    function showUserActions(userId, userName) {
        selectedUserId = userId;
        selectedUserName = userName;
        document.getElementById("userActionName").textContent = userName;
        new bootstrap.Modal(document.getElementById("userActionsModal")).show();
    }

    async function banUser() {
        if (!selectedUserId) return;

        if (!confirm(`Are you sure you want to ban ${selectedUserName}? This will suspend their account.`)) {
            return;
        }

        try {
            await apiCall(`/admin/users/${selectedUserId}/suspend`, "POST", {
                reason: "Banned by admin"
            });

            showAlert(`User ${selectedUserName} has been banned successfully`, "success");
            bootstrap.Modal.getInstance(document.getElementById("userActionsModal")).hide();

            // Reload requests to reflect changes
            await loadRequests();
        } catch (error) {
            showAlert("Failed to ban user: " + error.message, "danger");
        }
    }
</script>
<!-- Register Staff Modal -->
<div class="modal fade" id="registerStaffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register New Staff Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerStaffForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="staffFullName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="staffFullName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="staffEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="staffEmail" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="staffPhone" class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="staffPhone" placeholder="+8801XXXXXXXXX"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="staffBloodType" class="form-label">Blood Type *</label>
                            <select class="form-select" id="staffBloodType" required>
                                <option value="">Select Blood Type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="staffZilla" class="form-label">Zilla/District *</label>
                            <select class="form-select" id="staffZilla" required>
                                <option value="">Select Zilla</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="staffThana" class="form-label">Thana/Upazila *</label>
                            <select class="form-select" id="staffThana" required>
                                <option value="">Select Thana</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffPassword" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="staffPassword" minlength="6" required>
                        <small class="text-muted">Minimum 6 characters</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitRegisterStaff()">Register Staff</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function showRegisterStaffModal() {
        // Load zillas
        try {
            const data = await apiCall("/locations/zillas");
            const zillaSelect = document.getElementById("staffZilla");
            zillaSelect.innerHTML = "<option value=\"\">Select Zilla</option>" +
                data.zillas.map(z => `<option value="${z.id}">${z.name}</option>`).join("");

            // Add change listener for zilla
            zillaSelect.onchange = async function () {
                const zillaId = this.value;
                if (zillaId) {
                    const thanaData = await apiCall(`/locations/thanas/${zillaId}`);
                    const thanaSelect = document.getElementById("staffThana");
                    thanaSelect.innerHTML = "<option value=\"\">Select Thana</option>" +
                        thanaData.thanas.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
                }
            };

            new bootstrap.Modal(document.getElementById("registerStaffModal")).show();
        } catch (error) {
            showAlert("Failed to load locations", "danger");
        }
    }

    async function submitRegisterStaff() {
        const fullName = document.getElementById("staffFullName").value;
        const email = document.getElementById("staffEmail").value;
        const phone = document.getElementById("staffPhone").value;
        const bloodType = document.getElementById("staffBloodType").value;
        const zillaId = document.getElementById("staffZilla").value;
        const thanaId = document.getElementById("staffThana").value;
        const password = document.getElementById("staffPassword").value;

        if (!fullName || !email || !phone || !bloodType || !zillaId || !thanaId || !password) {
            showAlert("Please fill all required fields", "warning");
            return;
        }

        try {
            const result = await apiCall("/admin/create-staff", "POST", {
                full_name: fullName,
                email: email,
                phone: phone,
                blood_type: bloodType,
                address_zilla: parseInt(zillaId),
                address_thana: parseInt(thanaId),
                password: password
            });

            showAlert("Staff member registered successfully!", "success");
            bootstrap.Modal.getInstance(document.getElementById("registerStaffModal")).hide();
            document.getElementById("registerStaffForm").reset();
        } catch (error) {
            showAlert("Failed to register staff: " + error.message, "danger");
        }
    }
</script>