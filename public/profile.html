<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - LifeLine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">LifeLine</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToDashboard()">‚Üê Back to Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-4">Profile Settings</h2>

                <!-- Personal Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Personal Information</h4>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="full_name" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="full_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="blood_type" class="form-label">Blood Type</label>
                                    <select class="form-select" id="blood_type" required>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" readonly>
                                    <small class="text-muted">Email cannot be changed</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="address_zilla" class="form-label">Zilla/District</label>
                                    <select class="form-select" id="address_zilla" required>
                                        <option value="">Select Zilla</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="address_thana" class="form-label">Thana/Upazila</label>
                                    <select class="form-select" id="address_thana" required>
                                        <option value="">Select Thana</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>

                <!-- Role Management -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Role Management</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>ü©∏ Blood Donor</h5>
                                        <p class="text-muted">Donate blood to help save lives</p>
                                        <div id="donorRoleStatus"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>üôè Blood Receiver</h5>
                                        <p class="text-muted">Request blood when needed</p>
                                        <div id="receiverRoleStatus"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Information -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Account Information</h4>
                    </div>
                    <div class="card-body">
                        <p><strong>Account Created:</strong> <span id="createdAt"></span></p>
                        <p><strong>Last Updated:</strong> <span id="updatedAt"></span></p>
                        <div id="donorStats" style="display:none;">
                            <p><strong>Total Points:</strong> <span id="totalPoints" class="badge bg-success"></span>
                            </p>
                            <p><strong>Last Donation:</strong> <span id="lastDonation"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;

            currentUser = getUser();
            await loadProfile();
            await loadZillas('address_zilla');

            document.getElementById('address_zilla').addEventListener('change', async (e) => {
                if (e.target.value) {
                    await loadThanas(e.target.value, 'address_thana');
                }
            });
        });

        async function loadProfile() {
            try {
                const data = await apiCall('/auth/me');
                const user = data.user;

                // Populate form
                document.getElementById('full_name').value = user.full_name;
                document.getElementById('email').value = user.email;
                document.getElementById('phone').value = user.phone;
                document.getElementById('blood_type').value = user.blood_type;
                document.getElementById('address_zilla').value = user.address_zilla;

                // Load thanas for selected zilla
                if (user.address_zilla) {
                    await loadThanas(user.address_zilla, 'address_thana');
                    document.getElementById('address_thana').value = user.address_thana;
                }

                // Account info
                document.getElementById('createdAt').textContent = formatDateTime(user.created_at);
                document.getElementById('updatedAt').textContent = formatDateTime(user.updated_at);

                // Donor stats
                if (user.is_donor) {
                    document.getElementById('donorStats').style.display = 'block';
                    document.getElementById('totalPoints').textContent = user.points || 0;
                    document.getElementById('lastDonation').textContent = user.last_donation_date ? formatDate(user.last_donation_date) : 'Never';
                }

                // Role management
                updateRoleButtons(user);

            } catch (error) {
                showAlert('Failed to load profile: ' + error.message, 'danger');
            }
        }

        function updateRoleButtons(user) {
            const donorStatus = document.getElementById('donorRoleStatus');
            const receiverStatus = document.getElementById('receiverRoleStatus');

            if (user.is_donor) {
                donorStatus.innerHTML = `
                    <span class="badge bg-success mb-2">Active</span><br>
                    <button class="btn btn-sm btn-danger" onclick="disableRole('donor')">Disable</button>
                `;
            } else {
                donorStatus.innerHTML = `
                    <span class="badge bg-secondary mb-2">Inactive</span><br>
                    <button class="btn btn-sm btn-success" onclick="enableRole('donor')">Enable</button>
                `;
            }

            if (user.is_receiver) {
                receiverStatus.innerHTML = `
                    <span class="badge bg-success mb-2">Active</span><br>
                    <button class="btn btn-sm btn-danger" onclick="disableRole('receiver')">Disable</button>
                `;
            } else {
                receiverStatus.innerHTML = `
                    <span class="badge bg-secondary mb-2">Inactive</span><br>
                    <button class="btn btn-sm btn-success" onclick="enableRole('receiver')">Enable</button>
                `;
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const profileData = {
                full_name: document.getElementById('full_name').value,
                phone: document.getElementById('phone').value,
                blood_type: document.getElementById('blood_type').value,
                address_zilla: parseInt(document.getElementById('address_zilla').value),
                address_thana: parseInt(document.getElementById('address_thana').value)
            };

            try {
                await apiCall('/profile', 'PUT', profileData);
                showAlert('Profile updated successfully!', 'success');

                // Update stored user data
                const updatedUser = await apiCall('/auth/me');
                setUser(updatedUser.user);
                currentUser = updatedUser.user;
            } catch (error) {
                showAlert('Failed to update profile: ' + error.message, 'danger');
            }
        });

        async function enableRole(role) {
            if (!confirm(`Enable ${role} role?`)) return;

            try {
                await apiCall(`/profile/enable-${role}`, 'POST');
                showAlert(`${role.charAt(0).toUpperCase() + role.slice(1)} role enabled successfully!`, 'success');

                // Reload profile
                const updatedUser = await apiCall('/auth/me');
                setUser(updatedUser.user);
                currentUser = updatedUser.user;
                updateRoleButtons(currentUser);
            } catch (error) {
                showAlert(`Failed to enable ${role} role: ` + error.message, 'danger');
            }
        }

        async function disableRole(role) {
            if (!confirm(`Disable ${role} role? You won't be able to use ${role} features.`)) return;

            try {
                await apiCall('/profile/disable-role', 'POST', { role });
                showAlert(`${role.charAt(0).toUpperCase() + role.slice(1)} role disabled successfully!`, 'success');

                // Reload profile
                const updatedUser = await apiCall('/auth/me');
                setUser(updatedUser.user);
                currentUser = updatedUser.user;
                updateRoleButtons(currentUser);
            } catch (error) {
                showAlert(`Failed to disable ${role} role: ` + error.message, 'danger');
            }
        }

        function goToDashboard() {
            if (currentUser.is_admin) {
                window.location.href = '/admin-dashboard.html';
            } else if (currentUser.is_staff) {
                window.location.href = '/staff-dashboard.html';
            } else if (currentUser.is_donor) {
                window.location.href = '/donor-dashboard.html';
            } else if (currentUser.is_receiver) {
                window.location.href = '/receiver-dashboard.html';
            } else {
                window.location.href = '/';
            }
        }
    </script>
</body>

</html>